<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<meta name="GENERATOR" content="Microsoft&reg; HTML Help Workshop 4.1">
<Title>ForestUtil</Title>
<Style>
table, th, td {
	border: 1px, solid black;
}
P {
background-color: LightGray;
}
</Style>
</HEAD>
<BODY>
<H1>ForestUtil</H1>
<H2>Утилита для загрузки ежеквартальных отчетов в БД ФГУ «Рослеснадзор».</H2>

<OL>
<LI><H3>Внешний вид</H3><br>
Главное окно программы представляет из себя окно с главным меню вверху, статусной строкой внизу, и рабочей областью, занимающей все оставшеся место в окне.<br>
Рабочая область имеет две вкладки - “XLS-файл”, для работы с XLS-файлами ежеквартальных отчетов, и  “SQL-запрос” для работы с БД.<br>
При переключении вкладок главное меню изменяется, отображая пункты, соответствующие вкладке. Также на каждой вкладке с правой стороны располагается панель с элементами управления, для каждой вкладки элементы свои. Также на вкладке “XLS-файл” в верхней части расположена панель с первоначальной подсказкой.<br>
При выполнении действий в программе результаты выводятся в поля результатов, невидимые в нормальном режиме.<br>
</LI>
<br>
<LI><H3>Настройка программы</H3><br>
Настройки программы располагаются в меню «Настройки»-«Настройки». Доступно изменение шаблонов 4-х «быстрых» скриптов, причем, необязательно дифференцировать их как Select, Insert, Update, Delete - при необходимости можно сделать, например, все 4 Select.<br>
Также доступно изменять настройки подключения к БД PostgreSQL.
<b>ВНИМАНИЕ - пароль к БД хранится в явном виде.</b><br>
Настройка «Запоминать запросов» отвечает за количество запросов, которое программа запоминает в историю, для быстрого вызова ранее выполненных запросов.<br>
Настройка «Сворачиваться в трей» отвечает за поведение программы при минимизации - сворачиваться на панель задач (False) или сворачиваться в трей (True).<br>
Настройки словарей проверки располагаются в меню «Настройки»-«Настройка словарей».<br>
Для каждого словаря доступна загрузка правильных значений из БД. Эти значения будут использоваться для подстановки при автозамене неправильных значений полей из файла. Также можно добавлять значения вручную, но делать это строго не рекомендуется. Разрешается это делать только если Вы действительно понимаете, что делаете.<br>
Вышеприведенные настройки сохраняются в файле Settings.ini. В нем также присутствуют значения счетчиков ReadingIndex и WritingIndex, изменять которые строго не рекомендуется.<br>
</LI>
<br>
<LI><H3>Визуальные настройки</H3><br>
Для лучшего восприятия XLS-файла, содержащего большое количество столбцов, можно включить вид со сжатыми колонками. При этом ширина колонок файла будут уменьшена до такой ширины, чтобы все колонки убирались в видимой области сетки. При этом выделенная колонка будет иметь ширину 1/10 ширины видимой области сетки. Для переключения столбцов следует щелкать по их заголовкам.<br>
</LI>
<br>
<LI><H3>Открытие и проверка XLS-файла.</H3><br>
Для открытия XLS-файла можно использовать следующие методы:<br>
<UL>
<LI>Горячие клавиши Ctrl+O;<br></LI>
<LI>Пункт меню «Файл»-«Открыть файл» на закладке «XLS-файл»;<br></LI>
<LI>Щелкнуть по панели с соответствующей подсказкой;<br></LI>
<LI>Перетащить файл в окно программы (drag'n'drop);<br></LI>
<LI>Запустить программу из командной строки с ключом «-file ИмяФайла.xls».<br></LI>
</UL>
После открытия файла программа сменит фон сетки на темно-серый для индикации, что файл открыт. Статусное сообщение сменится на «Ожидание выбора таблицы», а выпадающее меню выбора таблицы станет активным.<br>
Далее следует выбрать таблицу (лист, sheet) файла, на котором располагаются данные для проверки. После выбора фон сетки снова станет белым, а данные отобразятся в сетке. Также программа выведет окно запроса региона, лесничества отчетного квартала и отчетного года, данные о которых располагаются в файле. Списки лесничеств берутся из соответствующих словарей.<br>
После указания выше указанных данных программа будет готова к проверке, статусное сообщение сменится на «Готово к работе» и отобразится количество строк в таблице файла (в том числе заголовочных, пустых и прочих нефункциональных).<br>
Проверка файла проводится в два этапа: математическая проверка с поиском дублирующихся строк и текстовая проверка с формированием итогового скрипта для БД.<br>
Математическая проверка запускается нажатием кнопки «Проверить файл», а текстовая - нажатием кнопки «Сформировать скрипт», или одноименными пунктами меню «Файл».<br>
Сняв флажок «Продолжать проверку при ошибках» можно включить режим, при котором программа будет останавливать проверку при первой же найденной ошибке.<br>
В ходе выполнения проверки программа будет выводить в нижней части окна лог сообщений. После проверки его можно сохранить нажатием кнопки «Сохранить результаты проверки».<br>
<UL>
<LI>Особенности текстовой проверки:<br></LI>
</UL>
При выполнении текстовой проверки программа будет автоматически заменять значения, имеющиеся в словарях автозамены. Можно включить ручное подтверждение каждой замены, выставив соответствующий флажок «Подтверждать замены вручную». Если программе попадется змачение, которого нет в словаре автозамены – программа выведет окно «обучения» автозамены, с предложением выбрать корректное значение из словаря для данной строки. При подтверждении выбора пара значений сохраняется в словарь автозамен для дальнейшего использования. «Обучение» можно пропустить, нажав кнопку «Пропустить». Также можно пропустить все ошибки в колонке, нажав кнопку «Пропустить все». Не рекомендуется всего этого делать, потому что при этом значения остаются прежними, и в таком виде будут использоваться в скриптах поиска идентификатора.<br>
После выполнения текстовой проверки будет сформирован скрипт для БД и загружен в поле текста скрипта на закладке «SQL-запрос».<br>
</LI>
<br>
<LI><H3>Выпронение SQL-запросов.</H3><br>
На закладке SQL-запрос доступно выполнение SQL-запросов. Для этого в основном поле следует ввести текст запроса, а переключатель «Тип запроса» выставить в надлежащее положение - для запросов, возвращающих результирующую таблицу - тип «Выборка», для остальных - тип «Команда». После этого нажать кнопку «Выполнить запрос» или выбрать одноименный пункт меню «Файл». При этом программа автоматически проверит текст запроса на соответствие типа, и в случае несовпадения - выведет окно подтверждения. Это сделано для правильного выполнения сложных запросов.<br>
После выполнения запроса, если он возвращает результат, в нижней части окна появится сетка с результирующей таблицей. Сохранить ее в файл можно нажав кнопку «Сохранить выборку в файл» или выбрав одноименный пункт меню «Файл».
Также, после успешного выполнения запроса, он сохраняется в историю запросов. С помощью кнопок «История запросов» можно просмотреть ее, выбрать и повторно выполнить ранее выполненные запросы.<br>
В текст запроса можно быстро добавлять определяемые пользователем шаблоны. Для этого используются 4 кнопки в блоке «Вставить шаблон». Также там присутствует кнопка для очистки текста текущего запроса.<br>
Использовав пункты меню «Файл»-«Загрузить запрос из файла» и «Файл»-«Сохранить запрос в файл» можно, соответственно, загрузить текст запроса из sql-файла или сохранить текст текущего запроса в sql-файл.<br>
</LI>
<br>
<LI><H3>Алгоритмы</H3><br>
<UL>
<LI>Алгоритм поиска первой строки данных в XLS-файле:<br>
<br>
<P>
<font face="monospace">
Цикл смещения по столбцам вправо от 0 до (Всего колонок в файле - 68):<br>
{<br>
&nbsp&nbspПерейти на первую строку;<br>
<br>
&nbsp&nbspЦикл до конца файла, выполнять:<br>
&nbsp&nbsp{<br>
&nbsp&nbsp&nbsp&nbspЗначимость строки = 0;<br>
<br>
&nbsp&nbsp&nbsp&nbspЦикл прохода по ячейкам вправо от 2 до 68:<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspЕсли значение в ячейке = счетчик цикла, то<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspУвеличить значимость строки;<br>
<br>
&nbsp&nbsp&nbsp&nbspЕсли Значимость > 32, то<br>
&nbsp&nbsp&nbsp&nbsp{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspНомер первой строки = Номер текущей записи;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspНомер первой колонки = Смещение по столбцам;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspВыставить флаг успеха;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspПрервать цикл;<br>
&nbsp&nbsp&nbsp&nbsp}<br>
<br>
&nbsp&nbsp&nbsp&nbspПерейти к следующей записи;<br>
&nbsp&nbsp}<br>
<br>
&nbsp&nbspЕсли выставлен флаг успеха, то<br>
&nbsp&nbsp&nbsp&nbspПрервать цикл;<br>
}<br>
</font>
</P>
</LI>
<br>
<LI>Алгоритм поиска последней строки данных в XLS-файле:<br>
<br>
<P>
<font face="monospace">
Цикл до конца файла, выполнять:<br>
{<br>
&nbsp&nbspНомер проверяемой записи = Номер текущей записи;<br>
&nbsp&nbspЕсли запись пустая, то<br>
&nbsp&nbsp{<br>
&nbsp&nbsp&nbsp&nbspПерейти к следующей строке;<br>
<br>
&nbsp&nbsp&nbsp&nbspЕсли встречен признак конца файла, то<br>
&nbsp&nbsp&nbsp&nbsp{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspНомер последней строки = Номер проверяемой записи;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspВыставить флаг успеха;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspПрервать цикл;<br>
&nbsp&nbsp&nbsp&nbsp}<br>
<br>
&nbsp&nbsp&nbsp&nbspЕсли запись пустая, то<br>
&nbsp&nbsp&nbsp&nbsp{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspПерейти к следующей строке;<br>
<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspЕсли встречен признак конца файла, то<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspНомер последней строки = Номер проверяемой записи;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspВыставить флаг успеха;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspПрервать цикл;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp}<br>
<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbspЕсли запись пустая, то<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp{<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspНомер последней строки = Номер проверяемой записи;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspВыставить флаг успеха<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspПрервать цикл;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp}<br>
&nbsp&nbsp&nbsp&nbsp}<br>
&nbsp&nbsp}<br>
&nbsp&nbspЕсли выставлен флаг успеха, то<br>
&nbsp&nbsp&nbsp&nbspПрервать цикл;<br>
<br>
&nbsp&nbspПерейти к строке(Номер проверяемой записи);<br>
&nbsp&nbspПерейти к следующей строке;<br>
}<br>
<br>
/*Проверка очень частного случая*/<br>
Если встречен признак конца файла, то<br>
{<br>
&nbsp&nbspНомер последней строки = Номер проверяемой записи;<br>
&nbsp&nbspВыставить флаг успеха;<br>
}<br>
</font>
</P>
</LI>
<br>
<LI>Алгоритм проверки пустая ли запись, используется в поиске последней строки данных:<br>
<br>
<P>
<font size="3" face="monospace">
Значимость = 0;<br>
<br>
Цикл прохода по колонкам в строке от 1 до 11, выполнять:<br>
{<br>
&nbsp&nbspЕсли Удалить_пробелы(Значение ячейки) = пустая строка, то<br>
&nbsp&nbsp&nbsp&nbspУвеличить значимость;<br>
}<br>
<br>
Успех, если Значимость > 6;<br>
</font>
</P>
</LI>
</UL>
<br>
<br>
<LI><H3>Список горячих клавиш</H3><br>
<TABLE>
<TR>
<TH>Комбинация клавиш</TH><TH>Закладка «XLS-файл»</TH><TH>Закладка «SQL-запрос»</TH>
</TR>
<TR>
<TD>Ctrl+Q</TD><TD>Закрыть программу</TD><TD>Закрыть программу</TD>
</TR>
<TR>
<TD>Ctrl+O</TD><TD>Открыть XLS-файл</TD><TD>Открыть запрос из файла</TD>
</TR>
<TR>
<TD>Ctrl+S</TD><TD>-</TD><TD>Сохранить запрос в файл</TD>
</TR>
<TR>
<TD>Ctrl+Alt+S</TD><TD>-</TD><TD>Сохранить выборку в файл</TD>
</TR>
<TR>
<TD>Ctrl+F7</TD><TD>Проверить файл</TD><TD>-	</TD>
</TR>
<TR>
<TD>Ctrl+F8</TD><TD>Сформировать скрипт</TD><TD>-</TD>
</TR>
<TR>
<TD>F9</TD><TD>-</TD><TD>Выполнить запрос</TD>
</TR>
<TR>
<TD>Ctrl+1</TD><TD>-</TD><TD>Вставить шаблон SELECT</TD>
</TR>
<TR>
<TD>Ctrl+2</TD><TD>-</TD><TD>Вставить шаблон INSERT	</TD>
</TR>
<TR>
<TD>Ctrl+3</TD><TD>-</TD><TD>Вставить шаблон UPDATE</TD>
</TR>
<TR>
<TD>Ctrl+4</TD><TD>-</TD><TD>Вставить шаблон DELETE</TD>
</TR>
<TR>
<TD>Ctrl+5</TD><TD>-</TD><TD>Очистить текст запроса</TD>
</TR>
<TR>
<TD>Ctrl+Alt+&#8594</TD><TD>-</TD><TD>Следующий запрос</TD>
</TR>
<TR>
<TD>Ctrl+Alt+&#8592</TD><TD>-</TD><TD>Предыдущий запрос</TD>
</TR>
</TABLE>
</LI>
</OL>
<br>
</BODY>
</HTML>
